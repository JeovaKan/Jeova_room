# 中断、异常

## 概述

**基本响应的机制**

1. x86支持256个不同的中断向量；  
2. 实际地址模式下，从0开始的1k字节作为中断向量表；  
3. 表项有4个字节，两个字节作为段地址，两个字节作为偏移量；  
4. 这种方式不保险的原因在于，没有区分CPU模式； 

**PDP-11的做法**

- 使用PDP-11的方式，使用一个独立的新寄存器PSW。保存当前CPU的状态
，称为程序状态字。
- PSW有一个位段包含当前CPU的优先级和模式。用户程序无法通过修改PSW
的值来修改CPU的模式。
- 中断向量表的表项中，一部分是中断服务程序的入口地址，一部分是转入中断处理后的PSW字。

**中断发生了**

1. 从中断向量表对应中断号的位置，将服务地址装入程序计数器，将PSW状态字装入状态寄存器。
2. 将被中断的程序的PSW也同时压入堆栈。
3. 这样就实现了，跳转到中断服务的同时，也实现了CPU特权模式的切换。

**Intel怎么玩的**

_使用了更为复杂的”中断门“_

_原有的表项由中断服务地址改为，类似PSW外加服务地址的模式，实际更为复杂，称为“门”结构_

1. 当中断发生时，必须先通过门，才能转入服务地址；
2. 门并不是仅仅为了中断设立，当CPU特权级别改变的时候，如从用户级别3进入到系统级0；
3. 中断发生时，不仅可以切换CPU特权并转入服务程序，同时可以安排一次任务切换（上下文切换）【0.0不明白这样做的好处】。
***
## 各种门

- 四种门： 任务门（task gate）、中断门（interrupt gate）、陷阱门（trap gate）、调用门（call gate）
- 相同和不同： 任务门结构较为不同，调用门不联系中断向量表。

### 任务门

- 任务门结构，是一个64位的数据。
   -  bit63~48 未使用；
   -  bit47    P标志位，P = 1时，代表在内存中；
   -  bit46~45 DPL级别，0系统级，3用户级；
   -  bit44~40 类型码。00101，其中101代表任务门；
   -  bit39~32 8位未使用；
   -  bit31~16 TSS段选择码；
   -  bit15~0  未使用； 

- TSS段选择码
   - 功能和CS、DS类似，只是通过GDT指向了特殊的段，“任务状态段”TSS。
   - 该数据段的内容，保存了CPU中所有与进程相关的寄存器内容，包括三个堆栈指针。
